---
title: 使用 migrate.exe-EF6
author: divega
ms.date: 2016-10-23
ms.assetid: 989ea862-e936-4c85-926a-8cfbef5df5b8
ms.openlocfilehash: 39740578e4a8c2d5400bcabbcb107baf0648fba5
ms.sourcegitcommit: dadee5905ada9ecdbae28363a682950383ce3e10
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/27/2018
ms.locfileid: "42993494"
---
# <a name="using-migrateexe"></a><span data-ttu-id="c627a-102">使用 migrate.exe</span><span class="sxs-lookup"><span data-stu-id="c627a-102">Using migrate.exe</span></span>
<span data-ttu-id="c627a-103">可以使用 code First 迁移更新数据库从内部 visual studio 中，但也可以通过命令行工具 migrate.exe 执行。</span><span class="sxs-lookup"><span data-stu-id="c627a-103">Code First Migrations can be used to update a database from inside visual studio, but can also be executed via the command line tool migrate.exe.</span></span> <span data-ttu-id="c627a-104">此页将提供有关如何使用 migrate.exe 执行针对数据库迁移的快速概述。</span><span class="sxs-lookup"><span data-stu-id="c627a-104">This page will give a quick overview on how to use migrate.exe to execute migrations against a database.</span></span>

> [!NOTE]
> <span data-ttu-id="c627a-105">本文假定你知道如何在基本方案中使用 Code First 迁移。</span><span class="sxs-lookup"><span data-stu-id="c627a-105">This article assumes you know how to use Code First Migrations in basic scenarios.</span></span> <span data-ttu-id="c627a-106">如果不这样做，则你将需要读取[Code First 迁移](~/ef6/modeling/code-first/migrations/index.md)然后再继续。</span><span class="sxs-lookup"><span data-stu-id="c627a-106">If you don’t, then you’ll need to read [Code First Migrations](~/ef6/modeling/code-first/migrations/index.md) before continuing.</span></span>

## <a name="copy-migrateexe"></a><span data-ttu-id="c627a-107">复制 migrate.exe</span><span class="sxs-lookup"><span data-stu-id="c627a-107">Copy migrate.exe</span></span>

<span data-ttu-id="c627a-108">在安装实体框架时使用 NuGet migrate.exe 将下载的包的工具文件夹内。</span><span class="sxs-lookup"><span data-stu-id="c627a-108">When you install Entity Framework using NuGet migrate.exe will be inside the tools folder of the downloaded package.</span></span> <span data-ttu-id="c627a-109">在中&lt;项目文件夹&gt;\\包\\EntityFramework。&lt;版本&gt;\\工具</span><span class="sxs-lookup"><span data-stu-id="c627a-109">In &lt;project folder&gt;\\packages\\EntityFramework.&lt;version&gt;\\tools</span></span>

<span data-ttu-id="c627a-110">一旦有 migrate.exe 然后需要将其复制到包含你迁移的程序集的位置。</span><span class="sxs-lookup"><span data-stu-id="c627a-110">Once you have migrate.exe then you need to copy it to the location of the assembly that contains your migrations.</span></span>

<span data-ttu-id="c627a-111">如果应用程序面向.NET 4 中，并且不 4.5，然后你将需要复制**Redirect.config**到位置一样以及与将其重命名**migrate.exe.config**。这是以便 migrate.exe 获取正确的绑定重定向，以便能够找到实体框架程序集。</span><span class="sxs-lookup"><span data-stu-id="c627a-111">If your application targets .NET 4, and not 4.5, then you will need to copy the **Redirect.config** into the location as well and rename it **migrate.exe.config**. This is so that migrate.exe gets the correct binding redirects to be able to locate the Entity Framework assembly.</span></span>

| <span data-ttu-id="c627a-112">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="c627a-112">.NET 4.5</span></span>                                   | <span data-ttu-id="c627a-113">.NET 4.0</span><span class="sxs-lookup"><span data-stu-id="c627a-113">.NET 4.0</span></span>                                   |
|:-------------------------------------------|:-------------------------------------------|
| ![Net45Files](~/ef6/media/net45files.png)  | ![Net40Files](~/ef6/media/net40files.png)  |

> [!NOTE]
> <span data-ttu-id="c627a-116">migrate.exe 不支持 x64 的程序集。</span><span class="sxs-lookup"><span data-stu-id="c627a-116">migrate.exe doesn't support x64 assemblies.</span></span>

## <a name="using-migrateexe"></a><span data-ttu-id="c627a-117">使用 Migrate.exe</span><span class="sxs-lookup"><span data-stu-id="c627a-117">Using Migrate.exe</span></span>

<span data-ttu-id="c627a-118">一旦已移至正确的文件夹的 migrate.exe 则应能够使用它来执行对数据库的迁移。</span><span class="sxs-lookup"><span data-stu-id="c627a-118">Once you have moved migrate.exe to the correct folder then you should be able to use it to execute migrations against the database.</span></span> <span data-ttu-id="c627a-119">该实用程序用于执行操作的就是执行迁移。</span><span class="sxs-lookup"><span data-stu-id="c627a-119">All the utility is designed to do is execute migrations.</span></span> <span data-ttu-id="c627a-120">它不能生成迁移或创建一个 SQL 脚本。</span><span class="sxs-lookup"><span data-stu-id="c627a-120">It cannot generate migrations or create a SQL script.</span></span>

### <a name="see-options"></a><span data-ttu-id="c627a-121">请参阅选项</span><span class="sxs-lookup"><span data-stu-id="c627a-121">See options</span></span>

``` console
Migrate.exe /?
```

<span data-ttu-id="c627a-122">更高版本将显示与此实用程序，请注意，需要能够 EntityFramework.dll 正在 migrate.exe 为了使此功能在同一位置相关联的帮助页。</span><span class="sxs-lookup"><span data-stu-id="c627a-122">The above will display the help page associated with this utility, note that you will need to have the EntityFramework.dll in the same location that you are running migrate.exe in order for this to work.</span></span>

### <a name="migrate-to-the-latest-migration"></a><span data-ttu-id="c627a-123">迁移到最新的迁移</span><span class="sxs-lookup"><span data-stu-id="c627a-123">Migrate to the latest migration</span></span>

``` console
Migrate.exe MyMvcApplication.dll /startupConfigurationFile=”..\\web.config”
```

<span data-ttu-id="c627a-124">当运行 migrate.exe 唯一必需的参数是程序集，这是包含想要运行的迁移的程序集，但它将使用所有约定基于设置，如果未指定配置文件。</span><span class="sxs-lookup"><span data-stu-id="c627a-124">When running migrate.exe the only mandatory parameter is the assembly, which is the assembly that contains the migrations that you are trying to run, but it will use all convention based settings if you do not specify the configuration file.</span></span>

### <a name="migrate-to-a-specific-migration"></a><span data-ttu-id="c627a-125">迁移到特定的迁移</span><span class="sxs-lookup"><span data-stu-id="c627a-125">Migrate to a specific migration</span></span>

``` console
Migrate.exe MyApp.exe /startupConfigurationFile=”MyApp.exe.config” /targetMigration=”AddTitle”
```

<span data-ttu-id="c627a-126">如果你想要运行到特定迁移的迁移，你可以指定迁移的名称。</span><span class="sxs-lookup"><span data-stu-id="c627a-126">If you want to run migrations up to a specific migration, then you can specify the name of the migration.</span></span> <span data-ttu-id="c627a-127">这将根据需要运行所有以前的迁移之前获取到指定的迁移。</span><span class="sxs-lookup"><span data-stu-id="c627a-127">This will run all previous migrations as required until getting to the migration specified.</span></span>

### <a name="specify-working-directory"></a><span data-ttu-id="c627a-128">指定工作目录</span><span class="sxs-lookup"><span data-stu-id="c627a-128">Specify working directory</span></span>

``` console
Migrate.exe MyApp.exe /startupConfigurationFile=”MyApp.exe.config” /startupDirectory=”c:\\MyApp”
```

<span data-ttu-id="c627a-129">如果您的程序集具有依赖关系或读取文件相对于工作目录，你将需要设置 startupDirectory。</span><span class="sxs-lookup"><span data-stu-id="c627a-129">If you assembly has dependencies or reads files relative to the working directory then you will need to set startupDirectory.</span></span>

### <a name="specify-migration-configuration-to-use"></a><span data-ttu-id="c627a-130">指定要使用的迁移配置</span><span class="sxs-lookup"><span data-stu-id="c627a-130">Specify migration configuration to use</span></span>

``` console
Migrate.exe MyAssembly CustomConfig /startupConfigurationFile=”..\\web.config”
```

<span data-ttu-id="c627a-131">如果有多个迁移配置类，类继承 DbMigrationConfiguration，然后您需要指定这是要用于此执行。</span><span class="sxs-lookup"><span data-stu-id="c627a-131">If you have multiple migration configuration classes, classes inheriting from DbMigrationConfiguration, then you need to specify which is to be used for this execution.</span></span> <span data-ttu-id="c627a-132">这是通过提供可选的第二个参数而无需为上面的开关来指定。</span><span class="sxs-lookup"><span data-stu-id="c627a-132">This is specified by providing the optional second parameter without a switch as above.</span></span>

### <a name="provide-connection-string"></a><span data-ttu-id="c627a-133">提供连接字符串</span><span class="sxs-lookup"><span data-stu-id="c627a-133">Provide connection string</span></span>

``` console
Migrate.exe BlogDemo.dll /connectionString=”Data Source=localhost;Initial Catalog=BlogDemo;Integrated Security=SSPI” /connectionProviderName=”System.Data.SqlClient”
```

<span data-ttu-id="c627a-134">如果你想要指定连接字符串在命令行，则还必须提供的提供程序名称。</span><span class="sxs-lookup"><span data-stu-id="c627a-134">If you wish to specify a connection string at the command line then you must also provide the provider name.</span></span> <span data-ttu-id="c627a-135">未指定提供程序名称将导致异常。</span><span class="sxs-lookup"><span data-stu-id="c627a-135">Not specifying the provider name will cause an exception.</span></span>

## <a name="common-problems"></a><span data-ttu-id="c627a-136">常见问题</span><span class="sxs-lookup"><span data-stu-id="c627a-136">Common Problems</span></span>

| <span data-ttu-id="c627a-137">错误消息</span><span class="sxs-lookup"><span data-stu-id="c627a-137">Error Message</span></span>                                                                                                                                                                                                                                                                                                                      | <span data-ttu-id="c627a-138">解决方案</span><span class="sxs-lookup"><span data-stu-id="c627a-138">Solution</span></span>                                                                                                                                                                                                                                                                                             |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="c627a-139">未经处理的异常： System.IO.FileLoadException： 无法加载文件或程序集 EntityFramework，版本 = 5.0.0.0，区域性 = 中性，PublicKeyToken = b77a5c561934e089 或其某个依赖项。</span><span class="sxs-lookup"><span data-stu-id="c627a-139">Unhandled Exception: System.IO.FileLoadException:  Could not load file or assembly 'EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089' or one of its dependencies.</span></span> <span data-ttu-id="c627a-140">找到的程序集清单定义与程序集引用不匹配。</span><span class="sxs-lookup"><span data-stu-id="c627a-140">The located assembly's manifest definition does not match the assembly reference.</span></span> <span data-ttu-id="c627a-141">(异常来自 HRESULT: 0x80131040)</span><span class="sxs-lookup"><span data-stu-id="c627a-141">(Exception from HRESULT: 0x80131040)</span></span>         | <span data-ttu-id="c627a-142">这通常意味着没有 Redirect.config 文件的情况下运行的.NET 4 应用程序。</span><span class="sxs-lookup"><span data-stu-id="c627a-142">This typically means that you are running a .NET 4 application without the Redirect.config file.</span></span> <span data-ttu-id="c627a-143">您需要将 Redirect.config 复制到与 migrate.exe 相同的位置，并重命名为 migrate.exe.config。</span><span class="sxs-lookup"><span data-stu-id="c627a-143">You need to copy the Redirect.config to the same location as migrate.exe and rename it to migrate.exe.config.</span></span>                                                                                       |
| <span data-ttu-id="c627a-144">未经处理的异常： System.IO.FileLoadException： 无法加载文件或程序集 EntityFramework，版本 = 4.4.0.0，区域性 = 中性，PublicKeyToken = b77a5c561934e089 或其某个依赖项。</span><span class="sxs-lookup"><span data-stu-id="c627a-144">Unhandled Exception: System.IO.FileLoadException: Could not load file or assembly 'EntityFramework, Version=4.4.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089' or one of its dependencies.</span></span> <span data-ttu-id="c627a-145">找到的程序集清单定义与程序集引用不匹配。</span><span class="sxs-lookup"><span data-stu-id="c627a-145">The located assembly's manifest definition does not match the assembly reference.</span></span> <span data-ttu-id="c627a-146">(异常来自 HRESULT: 0x80131040)</span><span class="sxs-lookup"><span data-stu-id="c627a-146">(Exception from HRESULT: 0x80131040)</span></span>          | <span data-ttu-id="c627a-147">此异常表示正在使用 Redirect.config 应用程序复制到 migrate.exe 位置.NET 4.5。</span><span class="sxs-lookup"><span data-stu-id="c627a-147">This exception means that you are running a .NET 4.5 application with the Redirect.config copied to the migrate.exe location.</span></span> <span data-ttu-id="c627a-148">如果您的应用程序是.NET 4.5 然后不需要使用内部重定向配置文件。</span><span class="sxs-lookup"><span data-stu-id="c627a-148">If your app is .NET 4.5 then you do not need to have the config file with the redirects inside.</span></span> <span data-ttu-id="c627a-149">删除 migrate.exe.config 文件。</span><span class="sxs-lookup"><span data-stu-id="c627a-149">Delete the migrate.exe.config file.</span></span>                                    |
| <span data-ttu-id="c627a-150">错误： 无法更新数据库以匹配当前模型，因为有挂起的更改和禁用自动迁移。</span><span class="sxs-lookup"><span data-stu-id="c627a-150">ERROR: Unable to update database to match the current model because there are pending changes and automatic migration is disabled.</span></span> <span data-ttu-id="c627a-151">将处理的模型更改写入到基于代码的迁移，或者启用自动迁移。</span><span class="sxs-lookup"><span data-stu-id="c627a-151">Either write the pending model changes to a code-based migration or enable automatic migration.</span></span> <span data-ttu-id="c627a-152">设置为 true，则启用自动迁移到 DbMigrationsConfiguration.AutomaticMigrationsEnabled。</span><span class="sxs-lookup"><span data-stu-id="c627a-152">Set DbMigrationsConfiguration.AutomaticMigrationsEnabled to true to enable automatic migration.</span></span> | <span data-ttu-id="c627a-153">如果尚未创建迁移，以应对到模型中，所做的更改和数据库的模型不匹配时，将迁移正在运行，将发生此错误。</span><span class="sxs-lookup"><span data-stu-id="c627a-153">This error occurs if running migrate when you haven’t created a migration to cope with changes made to the model, and the database does not match the model.</span></span> <span data-ttu-id="c627a-154">将属性添加到 model 类，然后运行而无需创建迁移来升级数据库 migrate.exe 是此示例。</span><span class="sxs-lookup"><span data-stu-id="c627a-154">Adding a property to a model class then running migrate.exe without creating a migration to upgrade the database is an example of this.</span></span> |
| <span data-ttu-id="c627a-155">错误： 未解析为成员类型 System.Data.Entity.Migrations.Design.ToolingFacade+UpdateRunner,EntityFramework，版本 = 5.0.0.0，区域性 = 中性，PublicKeyToken = b77a5c561934e089。</span><span class="sxs-lookup"><span data-stu-id="c627a-155">ERROR: Type is not resolved for member 'System.Data.Entity.Migrations.Design.ToolingFacade+UpdateRunner,EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.</span></span>                                                                                                                                       | <span data-ttu-id="c627a-156">可以通过指定一个不正确的启动目录导致此错误。</span><span class="sxs-lookup"><span data-stu-id="c627a-156">This error can be caused by specifying an incorrect startup directory.</span></span> <span data-ttu-id="c627a-157">这必须是 migrate.exe 的位置</span><span class="sxs-lookup"><span data-stu-id="c627a-157">This must be the location of migrate.exe</span></span>                                                                                                                                                                                      |
| <span data-ttu-id="c627a-158">未经处理的异常： System.NullReferenceException： 对象引用未设置为某个对象的实例。</span><span class="sxs-lookup"><span data-stu-id="c627a-158">Unhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.</span></span> <br/>   <span data-ttu-id="c627a-159">在 System.Data.Entity.Migrations.Console.Program.Main (String [] args)</span><span class="sxs-lookup"><span data-stu-id="c627a-159">at System.Data.Entity.Migrations.Console.Program.Main(String[] args)</span></span>                                                                                                                                             | <span data-ttu-id="c627a-160">这可能引起不指定正在使用的方案所需的参数。</span><span class="sxs-lookup"><span data-stu-id="c627a-160">This can be caused by not specifying a required parameter for a scenario that you are using.</span></span> <span data-ttu-id="c627a-161">无需指定提供程序名称，例如指定的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="c627a-161">For example specifying a connection string without specifying the provider name.</span></span>                                                                                                                        |
| <span data-ttu-id="c627a-162">错误： 在程序集中 ClassLibrary1' 找多个迁移配置类型。</span><span class="sxs-lookup"><span data-stu-id="c627a-162">ERROR: More than one migrations configuration type was found in the assembly 'ClassLibrary1'.</span></span> <span data-ttu-id="c627a-163">指定是要使用的名称。</span><span class="sxs-lookup"><span data-stu-id="c627a-163">Specify the name of the one to use.</span></span>                                                                                                                                                                                                  | <span data-ttu-id="c627a-164">该错误指出，给定的程序集没有多个配置类。</span><span class="sxs-lookup"><span data-stu-id="c627a-164">As the error states, there is more than one configuration class in the given assembly.</span></span> <span data-ttu-id="c627a-165">必须使用 /configurationType 开关来指定要使用。</span><span class="sxs-lookup"><span data-stu-id="c627a-165">You must use the /configurationType switch to specify which to use.</span></span>                                                                                                                                           |
| <span data-ttu-id="c627a-166">错误： 无法加载文件或程序集 '&lt;assemblyName&gt;或其某个依赖项。</span><span class="sxs-lookup"><span data-stu-id="c627a-166">ERROR: Could not load file or assembly ‘&lt;assemblyName&gt;’ or one of its dependencies.</span></span> <span data-ttu-id="c627a-167">给定的程序集名称或基本代码无效。</span><span class="sxs-lookup"><span data-stu-id="c627a-167">The given assembly name or codebase was invalid.</span></span> <span data-ttu-id="c627a-168">(异常来自 HRESULT: 0x80131047)</span><span class="sxs-lookup"><span data-stu-id="c627a-168">(Exception from HRESULT: 0x80131047)</span></span>                                                                                                                                                    | <span data-ttu-id="c627a-169">原因可能是通过指定程序集名称不正确或不具有</span><span class="sxs-lookup"><span data-stu-id="c627a-169">This can be caused by specifying an assembly name incorrectly or not having</span></span>                                                                                                                                                                                                                          |
| <span data-ttu-id="c627a-170">错误： 无法加载文件或程序集 '&lt;assemblyName&gt;或其某个依赖项。</span><span class="sxs-lookup"><span data-stu-id="c627a-170">ERROR: Could not load file or assembly ‘&lt;assemblyName&gt;' or one of its dependencies.</span></span> <span data-ttu-id="c627a-171">试图加载的程序的格式不正确。</span><span class="sxs-lookup"><span data-stu-id="c627a-171">An attempt was made to load a program with an incorrect format.</span></span>                                                                                                                                                                          | <span data-ttu-id="c627a-172">发生这种情况是如果你尝试运行 migrate.exe 针对 x64 应用程序。</span><span class="sxs-lookup"><span data-stu-id="c627a-172">This happens if you are trying to run migrate.exe against an x64 application.</span></span> <span data-ttu-id="c627a-173">EF 5.0 和 x86 上才会起下方。</span><span class="sxs-lookup"><span data-stu-id="c627a-173">EF 5.0 and below will only work on x86.</span></span>                                                                                                                                                                                |
